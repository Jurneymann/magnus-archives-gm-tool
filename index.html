<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-XBV69K4M8C"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-XBV69K4M8C");
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Magnus Archives - Game Master Tool</title>
    <link rel="icon" href="assets/favicon.png" type="image/png" />
    <!-- Base Styles & Core Layout -->
    <link rel="stylesheet" href="styles/base.css" />
    <link rel="stylesheet" href="styles/tabs.css" />

    <!-- GM Tool Features -->
    <link rel="stylesheet" href="styles/save-load.css" />
    <link rel="stylesheet" href="styles/gm-tools.css" />
    <link rel="stylesheet" href="styles/toolbar.css" />

    <!-- Legacy Character Sheet (if needed) -->
    <!-- <link rel="stylesheet" href="styles/legacy-character-sheet.css" /> -->
    <link
      href="https://fonts.googleapis.com/css?family=Libre+Baskerville&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <img
      src="assets/MagnusHeader.png"
      alt="https://images.steamusercontent.com/ugc/1658972820362899540/C807B188BF468B57BC6ED24CECDDBE50610019ED/?imw=637&imh=358&ima=fit&impolicy=Letterbox&imcolor=%23000000&letterbox=true"
      class="header-image"
    />

    <div class="sheet">
      <h1 id="pageTitle">Game Master Toolset</h1>

      <div style="text-align: center; margin: 10px 0 20px 0">
        <input
          type="text"
          id="campaignName"
          placeholder="Enter Campaign Name..."
          onchange="saveCampaignName()"
          style="
            font-family: 'Libre Baskerville', serif;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #4caf50;
            border-radius: 4px;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
            color: #4caf50;
            text-align: center;
            min-width: 90%;
            text-shadow: #4caf50 0px 0px 5px;
            font-weight: 600;
            letter-spacing: 2px;
            font-size: 1.2em;
          "
        />
      </div>

      <div class="tab-container">
        <div class="tab-buttons">
          <button class="tab-button active" data-tab="players">Players</button>
          <button class="tab-button" data-tab="story-notes">Story Notes</button>
          <button class="tab-button" data-tab="session-notes">
            Session Notes
          </button>
          <button class="tab-button" data-tab="encounters">
            Combat Tracker
          </button>
          <button class="tab-button" data-tab="artefacts">
            Artefacts & Books
          </button>
          <button class="tab-button" data-tab="bestiary">Bestiary</button>
          <button class="tab-button" data-tab="locations">Locations</button>
          <button class="tab-button" data-tab="npcs">NPCs</button>
        </div>

        <!-- Players Tab -->
        <div id="players" class="tab-content active">
          <div class="section">
            <h2>Player Characters</h2>
            <div class="reference-content" style="padding: 20px">
              <p
                style="
                  color: #888;
                  margin: 0 0 20px 0;
                  line-height: 1.6;
                  font-size: 0.95em;
                "
              >
                <strong>Manage your investigator party.</strong><br />
                Import character sheets to track player stats, abilities,
                stress, and damage. View party status at a glance and quickly
                add characters to combat encounters.
              </p>

              <div
                id="partyMembersList"
                style="
                  display: flex;
                  flex-direction: column;
                  gap: 15px;
                  margin-bottom: 15px;
                "
              >
                <p
                  class="empty-state"
                  style="text-align: center; color: #888; padding: 40px"
                >
                  No players added yet. Import character sheets below.
                </p>
              </div>
              <div style="display: flex; gap: 10px; margin-bottom: 30px">
                <button
                  class="button primary-button"
                  onclick="importCharacterSheet()"
                  style="flex: 1"
                >
                  <span style="font-size: 1.2em; margin-right: 5px">üìÑ</span>
                  Import Character Sheet
                </button>
                <button
                  class="button"
                  onclick="addPartyMember()"
                  style="
                    flex: 1;
                    background: rgba(76, 175, 80, 0.2);
                    border: 1px solid #4caf50;
                  "
                >
                  <span style="font-size: 1.2em; margin-right: 5px">+</span> Add
                  Manually
                </button>
              </div>

              <div
                class="dashboard-grid"
                style="display: none"
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                  gap: 20px;
                "
              >
                <div
                  class="dashboard-card"
                  style="
                    background: rgba(0, 0, 0, 0.3);
                    padding: 20px;
                    border-radius: 8px;
                    border: 1px solid #4caf50;
                  "
                >
                  <h3 style="color: #4caf50; margin-top: 0">Current Session</h3>
                  <div
                    class="session-info"
                    style="display: flex; flex-direction: column; gap: 10px"
                  >
                    <label for="sessionNumber">Session #</label>
                    <input type="number" id="sessionNumber" value="1" min="1" />
                    <label for="sessionDate">Date</label>
                    <input type="date" id="sessionDate" />
                    <label for="sessionTitle">Title/Arc</label>
                    <input
                      type="text"
                      id="sessionTitle"
                      placeholder="Enter session title..."
                    />
                  </div>
                </div>

                <div
                  class="dashboard-card"
                  style="
                    background: rgba(0, 0, 0, 0.3);
                    padding: 20px;
                    border-radius: 8px;
                    border: 1px solid #4caf50;
                  "
                >
                  <h3 style="color: #4caf50; margin-top: 0">Party Status</h3>
                  <div id="partyQuickStats" style="margin-bottom: 15px">
                    <p>Party size: <span id="partySize">0</span></p>
                    <p>Average Tier: <span id="avgTier">1</span></p>
                    <p>Active Players: <span id="activePlayers">0</span></p>
                  </div>
                  <button
                    class="button primary-button"
                    onclick="switchToTab('players')"
                  >
                    Manage Party
                  </button>
                </div>

                <div
                  class="dashboard-card"
                  style="
                    background: rgba(0, 0, 0, 0.3);
                    padding: 20px;
                    border-radius: 8px;
                    border: 1px solid #4caf50;
                  "
                >
                  <h3 style="color: #4caf50; margin-top: 0">Quick Actions</h3>
                  <div
                    class="quick-actions"
                    style="display: flex; flex-direction: column; gap: 10px"
                  >
                    <button class="button" onclick="switchToTab('encounters')">
                      Start Combat
                    </button>
                    <button class="button" onclick="switchToTab('npcs')">
                      Add NPC
                    </button>
                    <button class="button" onclick="generateRandomEncounter()">
                      Random Encounter
                    </button>
                    <button class="button" onclick="rollGroupInitiative()">
                      Roll Initiative
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Encounters Tab -->
        <div id="encounters" class="tab-content">
          <div class="section">
            <h2>Combat Encounter</h2>
            <div class="reference-content" style="padding: 20px">
              <p
                style="
                  color: #888;
                  margin: 0 0 20px 0;
                  line-height: 1.6;
                  font-size: 0.95em;
                "
              >
                <strong>Run tactical combat encounters.</strong><br />
                Add party members and enemies from your databases, roll
                initiative, and track health, stress, and damage throughout the
                fight. End combat to sync changes back to party members.
              </p>

              <!-- Add Combatants Section -->
              <div
                style="
                  margin-bottom: 20px;
                  padding: 15px;
                  background: rgba(0, 0, 0, 0.2);
                  border-radius: 8px;
                "
              >
                <h3 style="margin-bottom: 12px; color: #4caf50">
                  Add Combatants
                </h3>
                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                  "
                >
                  <button
                    class="button"
                    onclick="addAllPartyToCombat()"
                    title="Add all party members from Party tab"
                    style="width: 100%; padding: 12px"
                  >
                    üë• Add All Party
                  </button>
                  <button
                    class="button"
                    onclick="navigateToPartyTab()"
                    title="Add individual party members"
                    style="width: 100%; padding: 12px"
                  >
                    üé≠ From Party
                  </button>
                  <button
                    class="button"
                    onclick="navigateToBestiaryTab()"
                    title="Add creatures from the bestiary"
                    style="width: 100%; padding: 12px"
                  >
                    üìö From Bestiary
                  </button>
                  <button
                    class="button"
                    onclick="navigateToNPCsTab()"
                    title="Add NPCs you've created"
                    style="width: 100%; padding: 12px"
                  >
                    üë§ From NPCs
                  </button>
                </div>
              </div>

              <!-- Prepare Combat Section -->
              <div
                style="
                  margin-bottom: 20px;
                  padding: 15px;
                  background: rgba(0, 0, 0, 0.2);
                  border-radius: 8px;
                "
              >
                <h3 style="margin-bottom: 12px; color: #4caf50">
                  Prepare Combat
                </h3>
                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                  "
                >
                  <button
                    class="button primary-button"
                    onclick="combatPhase = 'initiative'; renderCombatTracker()"
                    title="Enter initiative values for all combatants"
                    style="width: 100%; padding: 12px"
                  >
                    üìù Set Initiative
                  </button>
                  <button
                    class="button"
                    onclick="randomizeAllNPCInitiative()"
                    title="Randomize initiative for all NPCs and creatures"
                    style="width: 100%; padding: 12px"
                  >
                    üé≤ Random NPC Initiative
                  </button>
                </div>
              </div>

              <!-- Run Combat Section -->
              <div
                style="
                  margin-bottom: 20px;
                  padding: 15px;
                  background: rgba(0, 0, 0, 0.2);
                  border-radius: 8px;
                "
              >
                <h3 style="margin-bottom: 12px; color: #4caf50">Run Combat</h3>
                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr 1fr;
                    gap: 10px;
                  "
                >
                  <button
                    class="button primary-button"
                    onclick="confirmInitiativeOrder()"
                    title="Confirm initiative and start combat"
                    style="width: 100%; padding: 12px"
                  >
                    ‚ñ∂Ô∏è Start Combat
                  </button>
                  <button
                    class="button"
                    onclick="nextTurn()"
                    title="Advance to next combatant's turn"
                    style="width: 100%; padding: 12px"
                  >
                    ‚è≠Ô∏è Next Turn
                  </button>
                  <button
                    class="button"
                    onclick="endCombat()"
                    style="width: 100%; padding: 12px; background: #d32f2f"
                    title="End combat and sync changes to Party tab"
                  >
                    üõë End Combat
                  </button>
                </div>
              </div>

              <!-- Initiative Tracker -->
              <div id="initiativeTracker">
                <h3>Combat Tracker</h3>
                <div
                  id="initiativeList"
                  style="
                    min-height: 200px;
                    background: rgba(0, 0, 0, 0.2);
                    border-radius: 8px;
                    padding: 15px;
                  "
                >
                  <p
                    class="empty-state"
                    style="text-align: center; color: #888"
                  >
                    No combatants. Add party members and NPCs to begin.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- NPCs Tab -->
        <div id="npcs" class="tab-content">
          <div class="section">
            <h2>Non-Player Characters</h2>
            <div class="reference-content" style="padding: 20px">
              <p
                style="
                  color: #888;
                  margin: 0 0 20px 0;
                  line-height: 1.6;
                  font-size: 0.95em;
                "
              >
                <strong>Populate your world with memorable characters.</strong
                ><br />
                Create NPCs with distinct roles, affiliations, and ties to the
                Entities. Track their abilities, relationships, and secrets to
                bring depth to your investigators' interactions and the
                unfolding narrative.
              </p>

              <!-- NPC Creator Form -->
              <div
                id="npcCreatorForm"
                style="
                  display: none;
                  background: rgba(0, 0, 0, 0.3);
                  padding: 5px;
                  border-radius: 8px;
                  border: 2px solid #66bb6a;
                "
              >
                <h3
                  style="color: #66bb6a; margin-top: 0; margin-bottom: 5px"
                  id="npcFormTitle"
                >
                  Create New NPC
                </h3>

                <div style="margin-bottom: 10px">
                  <label
                    style="
                      display: block;
                      margin-bottom: 3px;
                      color: #ccc;
                      font-weight: 600;
                      font-size: 0.9em;
                    "
                    >Name *</label
                  >
                  <input
                    type="text"
                    id="npcFormName"
                    placeholder="NPC Name"
                    style="
                      width: 100%;
                      padding: 6px 8px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #66bb6a;
                      border-radius: 4px;
                      color: #e0e0e0;
                      font-size: 0.95em;
                    "
                  />
                </div>

                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr 1fr;
                    gap: 10px;
                    margin-bottom: 10px;
                  "
                >
                  <div>
                    <label
                      style="
                        display: block;
                        margin-bottom: 3px;
                        color: #ccc;
                        font-weight: 600;
                        font-size: 0.9em;
                      "
                      >Level</label
                    >
                    <input
                      type="number"
                      id="npcFormLevel"
                      value="1"
                      min="1"
                      max="10"
                      style="
                        width: 100%;
                        padding: 6px 8px;
                        background: rgba(0, 0, 0, 0.3);
                        border: 1px solid #66bb6a;
                        border-radius: 4px;
                        color: #e0e0e0;
                        font-size: 0.95em;
                      "
                    />
                  </div>
                  <div>
                    <label
                      style="
                        display: block;
                        margin-bottom: 3px;
                        color: #ccc;
                        font-weight: 600;
                        font-size: 0.9em;
                      "
                      >Health</label
                    >
                    <input
                      type="number"
                      id="npcFormHealth"
                      value="10"
                      min="1"
                      style="
                        width: 100%;
                        padding: 6px 8px;
                        background: rgba(0, 0, 0, 0.3);
                        border: 1px solid #66bb6a;
                        border-radius: 4px;
                        color: #e0e0e0;
                        font-size: 0.95em;
                      "
                    />
                  </div>
                  <div>
                    <label
                      style="
                        display: block;
                        margin-bottom: 3px;
                        color: #ccc;
                        font-weight: 600;
                        font-size: 0.9em;
                      "
                      >Damage</label
                    >
                    <input
                      type="text"
                      id="npcFormDamage"
                      placeholder="e.g., 4 points"
                      style="
                        width: 100%;
                        padding: 6px 8px;
                        background: rgba(0, 0, 0, 0.3);
                        border: 1px solid #66bb6a;
                        border-radius: 4px;
                        color: #e0e0e0;
                        font-size: 0.95em;
                      "
                    />
                  </div>
                </div>

                <div style="margin-bottom: 10px">
                  <label
                    style="
                      display: block;
                      margin-bottom: 3px;
                      color: #ccc;
                      font-weight: 600;
                      font-size: 0.9em;
                    "
                    >Role</label
                  >
                  <input
                    type="text"
                    id="npcFormRole"
                    placeholder="e.g., Merchant, Guard, Leader..."
                    style="
                      width: 100%;
                      padding: 6px 8px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #66bb6a;
                      border-radius: 4px;
                      color: #e0e0e0;
                      font-size: 0.95em;
                    "
                  />
                </div>

                <div style="margin-bottom: 10px">
                  <label
                    style="
                      display: block;
                      margin-bottom: 3px;
                      color: #ccc;
                      font-weight: 600;
                      font-size: 0.9em;
                    "
                    >Affiliation</label
                  >
                  <input
                    type="text"
                    id="npcFormAffiliation"
                    placeholder="Organization, faction, or allegiance..."
                    style="
                      width: 100%;
                      padding: 6px 8px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #66bb6a;
                      border-radius: 4px;
                      color: #e0e0e0;
                      font-size: 0.95em;
                    "
                  />
                </div>

                <div style="margin-bottom: 10px">
                  <label
                    style="
                      display: block;
                      margin-bottom: 3px;
                      color: #ccc;
                      font-weight: 600;
                      font-size: 0.9em;
                    "
                    >Entity</label
                  >
                  <div class="custom-multiselect">
                    <div
                      class="multiselect-trigger"
                      id="npcFormEntityTrigger"
                      onclick="toggleNPCFormEntityDropdown()"
                    >
                      <span class="multiselect-placeholder"
                        >Select entities...</span
                      >
                    </div>
                    <div
                      class="multiselect-dropdown"
                      id="npcFormEntityDropdown"
                      style="display: none"
                    >
                      <div
                        class="multiselect-option"
                        onclick="event.stopPropagation(); toggleNPCFormEntity('None')"
                      >
                        <input type="checkbox" />
                        None
                      </div>
                    </div>
                  </div>
                </div>

                <div style="margin-bottom: 10px">
                  <label
                    style="
                      display: block;
                      margin-bottom: 3px;
                      color: #ccc;
                      font-weight: 600;
                      font-size: 0.9em;
                    "
                    >Description</label
                  >
                  <textarea
                    id="npcFormDescription"
                    placeholder="Physical description, personality, background..."
                    style="
                      width: 100%;
                      min-height: 70px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #66bb6a;
                      padding: 6px 8px;
                      border-radius: 4px;
                      color: #e0e0e0;
                      font-family: 'Segoe UI', sans-serif;
                      resize: vertical;
                      font-size: 0.9em;
                      line-height: 1.4;
                    "
                  ></textarea>
                </div>

                <div style="margin-bottom: 10px">
                  <label
                    style="
                      display: block;
                      margin-bottom: 3px;
                      color: #ccc;
                      font-weight: 600;
                      font-size: 0.9em;
                    "
                    >Abilities</label
                  >
                  <textarea
                    id="npcFormAbilities"
                    placeholder="Special abilities, attacks, resistances, powers..."
                    style="
                      width: 100%;
                      min-height: 70px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #66bb6a;
                      padding: 6px 8px;
                      border-radius: 4px;
                      color: #e0e0e0;
                      font-family: 'Segoe UI', sans-serif;
                      resize: vertical;
                      font-size: 0.9em;
                      line-height: 1.4;
                    "
                  ></textarea>
                </div>

                <div style="margin-bottom: 15px">
                  <label
                    style="
                      display: block;
                      margin-bottom: 3px;
                      color: #ccc;
                      font-weight: 600;
                      font-size: 0.9em;
                    "
                    >GM Notes</label
                  >
                  <textarea
                    id="npcFormGMNotes"
                    placeholder="Private notes, plot hooks, motivations, secrets..."
                    style="
                      width: 100%;
                      min-height: 70px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #66bb6a;
                      padding: 6px 8px;
                      border-radius: 4px;
                      color: #e0e0e0;
                      font-family: 'Segoe UI', sans-serif;
                      resize: vertical;
                      font-size: 0.9em;
                      line-height: 1.4;
                    "
                  ></textarea>
                </div>

                <div style="display: flex; gap: 10px">
                  <button
                    onclick="saveNPCFromForm()"
                    id="npcFormSubmit"
                    class="button primary-button"
                    style="flex: 1; padding: 8px 12px"
                  >
                    üíæ Save NPC
                  </button>
                  <button
                    onclick="clearNPCForm(); document.getElementById('npcCreatorForm').style.display = 'none';"
                    class="button secondary-button"
                    style="padding: 8px 12px"
                  >
                    Cancel
                  </button>
                </div>
              </div>

              <!-- NPC Action Buttons -->
              <div
                style="
                  display: flex;
                  gap: 10px;
                  margin-bottom: 15px;
                  flex-wrap: wrap;
                "
              >
                <button
                  class="button primary-button"
                  onclick="showNPCForm()"
                  style="padding: 10px 20px; flex: 1; min-width: 200px"
                >
                  ‚ûï Create New NPC
                </button>
                <button
                  class="button"
                  onclick="document.getElementById('npcsUpload').click()"
                  style="
                    padding: 10px 20px;
                    background: rgba(33, 150, 243, 0.2);
                    border: 1px solid #2196f3;
                    color: #64b5f6;
                    flex: 1;
                    min-width: 200px;
                  "
                  title="Upload a JSON file with multiple NPCs"
                >
                  üì§ Upload JSON
                </button>
                <button
                  class="button"
                  onclick="exportNPCsJSON()"
                  style="
                    padding: 10px 20px;
                    background: rgba(255, 152, 0, 0.2);
                    border: 1px solid #ff9800;
                    color: #ffb74d;
                    flex: 1;
                    min-width: 200px;
                  "
                  title="Download your NPCs as JSON"
                >
                  üíæ Export JSON
                </button>
                <button
                  class="button"
                  onclick="downloadNPCsTemplate()"
                  style="
                    padding: 10px 20px;
                    background: rgba(76, 175, 80, 0.2);
                    border: 1px solid #4caf50;
                    color: #81c784;
                    flex: 1;
                    min-width: 200px;
                  "
                  title="Download a blank template to create your own NPCs"
                >
                  üìã Download Template
                </button>
                <input
                  type="file"
                  id="npcsUpload"
                  accept=".json"
                  style="display: none"
                  onchange="importNPCsJSON(event)"
                />
              </div>

              <!-- Search and Filter Bar -->
              <div
                style="
                  display: grid;
                  grid-template-columns: 2fr 1fr 1fr 1fr 100px;
                  gap: 8px;
                  margin-bottom: 10px;
                "
              >
                <input
                  type="text"
                  id="npcSearch"
                  placeholder="üîç Search NPCs by name..."
                  oninput="filterNPCs()"
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #66bb6a;
                    border-radius: 6px;
                    color: #e0e0e0;
                  "
                />
                <select
                  id="npcFilterEntity"
                  onchange="filterNPCs()"
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #66bb6a;
                    border-radius: 6px;
                    color: #e0e0e0;
                  "
                >
                  <option value="">All Entities</option>
                  <option value="The Buried">The Buried</option>
                  <option value="The Corruption">The Corruption</option>
                  <option value="The Dark">The Dark</option>
                  <option value="The Desolation">The Desolation</option>
                  <option value="The End">The End</option>
                  <option value="The Eye">The Eye</option>
                  <option value="The Flesh">The Flesh</option>
                  <option value="The Hunt">The Hunt</option>
                  <option value="The Lonely">The Lonely</option>
                  <option value="The Slaughter">The Slaughter</option>
                  <option value="The Spiral">The Spiral</option>
                  <option value="The Stranger">The Stranger</option>
                  <option value="The Vast">The Vast</option>
                  <option value="The Web">The Web</option>
                </select>
                <select
                  id="npcFilterLevel"
                  onchange="filterNPCs()"
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #66bb6a;
                    border-radius: 6px;
                    color: #e0e0e0;
                  "
                >
                  <option value="">All Levels</option>
                  <option value="1">Level 1</option>
                  <option value="2">Level 2</option>
                  <option value="3">Level 3</option>
                  <option value="4">Level 4</option>
                  <option value="5">Level 5</option>
                  <option value="6">Level 6</option>
                  <option value="7">Level 7</option>
                  <option value="8">Level 8</option>
                  <option value="9">Level 9</option>
                  <option value="10">Level 10</option>
                </select>
                <select
                  id="npcFilterAffiliation"
                  onchange="filterNPCs()"
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #66bb6a;
                    border-radius: 6px;
                    color: #e0e0e0;
                  "
                >
                  <option value="">All Affiliations</option>
                </select>
                <button
                  class="button"
                  onclick="clearNPCFilters()"
                  style="padding: 8px"
                >
                  Clear
                </button>
              </div>

              <!-- Sort Options -->
              <div
                style="
                  margin-bottom: 10px;
                  display: flex;
                  gap: 8px;
                  align-items: center;
                "
              >
                <label style="color: #66bb6a; font-size: 0.9em">Sort by:</label>
                <select
                  id="npcSortBy"
                  onchange="filterNPCs()"
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #66bb6a;
                    border-radius: 6px;
                    color: #e0e0e0;
                    flex: 1;
                  "
                >
                  <option value="name">Name (A-Z)</option>
                  <option value="name-desc">Name (Z-A)</option>
                  <option value="level-asc">Level (Low to High)</option>
                  <option value="level-desc">Level (High to Low)</option>
                  <option value="affiliation">Affiliation (A-Z)</option>
                  <option value="affiliation-desc">Affiliation (Z-A)</option>
                </select>
              </div>

              <!-- List of NPCs -->
              <div
                id="npcsContainer"
                style="display: flex; flex-direction: column; gap: 6px"
              >
                <p
                  class="empty-state"
                  style="text-align: center; color: #888; padding: 40px"
                >
                  No NPCs created yet.
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Bestiary Tab -->
        <div id="bestiary" class="tab-content">
          <div class="section">
            <h2>Bestiary</h2>

            <!-- Bestiary Section -->
            <div class="reference-content" style="padding: 20px">
              <p
                style="
                  color: #888;
                  margin: 0 0 20px 0;
                  line-height: 1.6;
                  font-size: 0.95em;
                "
              >
                <strong>Build your collection of horrors.</strong><br />
                Create creatures and enemies aligned with the Entities, defining
                their stats, abilities, and combat behaviors. Export your
                bestiary as JSON or import pre-made collections to quickly
                populate encounters.
              </p>

              <!-- Enemy Creator Form -->
              <div
                id="customEnemyForm"
                style="
                  display: none;
                  background: rgba(0, 0, 0, 0.3);
                  padding: 20px;
                  border-radius: 8px;
                  border: 1px solid #4caf50;
                  margin-bottom: 20px;
                "
              >
                <h4
                  style="color: #4caf50; margin-top: 0"
                  id="customEnemyFormTitle"
                >
                  Create New Enemy
                </h4>

                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 15px;
                    margin-bottom: 15px;
                  "
                >
                  <div>
                    <label
                      for="customEnemyName"
                      style="display: block; margin-bottom: 5px; color: #ccc"
                      >Name *</label
                    >
                    <input
                      type="text"
                      id="customEnemyName"
                      placeholder="Enemy name..."
                      style="
                        width: 100%;
                        padding: 8px;
                        background: rgba(0, 0, 0, 0.3);
                        border: 1px solid #4caf50;
                        border-radius: 4px;
                        color: #e0e0e0;
                      "
                    />
                  </div>

                  <div>
                    <label
                      for="customEnemyLevel"
                      style="display: block; margin-bottom: 5px; color: #ccc"
                      >Level *</label
                    >
                    <input
                      type="number"
                      id="customEnemyLevel"
                      min="1"
                      max="10"
                      value="1"
                      style="
                        width: 100%;
                        padding: 8px;
                        background: rgba(0, 0, 0, 0.3);
                        border: 1px solid #4caf50;
                        border-radius: 4px;
                        color: #e0e0e0;
                      "
                    />
                  </div>
                </div>

                <div style="margin-bottom: 15px">
                  <label
                    for="customEnemyDescription"
                    style="display: block; margin-bottom: 5px; color: #ccc"
                    >Description</label
                  >
                  <textarea
                    id="customEnemyDescription"
                    rows="3"
                    placeholder="Physical description, appearance, behavior..."
                    style="
                      width: 100%;
                      padding: 8px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #4caf50;
                      border-radius: 4px;
                      color: #e0e0e0;
                      resize: vertical;
                    "
                  ></textarea>
                </div>

                <div style="margin-bottom: 15px">
                  <label
                    for="customEnemyEntity"
                    style="display: block; margin-bottom: 5px; color: #ccc"
                    >Entity</label
                  >
                  <div class="custom-multiselect">
                    <div
                      class="multiselect-trigger"
                      id="customEnemyEntityTrigger"
                      onclick="toggleCustomEnemyEntityDropdown()"
                    >
                      <span class="multiselect-placeholder"
                        >Select entities...</span
                      >
                    </div>
                    <div
                      class="multiselect-dropdown"
                      id="customEnemyEntityDropdown"
                      style="display: none"
                    >
                      <div
                        class="multiselect-option"
                        data-entity="None"
                        onclick="event.stopPropagation(); toggleCustomEnemyEntity('None')"
                      >
                        <input type="checkbox" />
                        None
                      </div>
                      <div
                        class="multiselect-option"
                        data-entity="The Buried"
                        onclick="event.stopPropagation(); toggleCustomEnemyEntity('The Buried')"
                      >
                        <input type="checkbox" />
                        The Buried
                      </div>
                      <div
                        class="multiselect-option"
                        data-entity="The Corruption"
                        onclick="event.stopPropagation(); toggleCustomEnemyEntity('The Corruption')"
                      >
                        <input type="checkbox" />
                        The Corruption
                      </div>
                      <div
                        class="multiselect-option"
                        data-entity="The Dark"
                        onclick="event.stopPropagation(); toggleCustomEnemyEntity('The Dark')"
                      >
                        <input type="checkbox" />
                        The Dark
                      </div>
                      <div
                        class="multiselect-option"
                        data-entity="The Desolation"
                        onclick="event.stopPropagation(); toggleCustomEnemyEntity('The Desolation')"
                      >
                        <input type="checkbox" />
                        The Desolation
                      </div>
                      <div
                        class="multiselect-option"
                        data-entity="The End"
                        onclick="event.stopPropagation(); toggleCustomEnemyEntity('The End')"
                      >
                        <input type="checkbox" />
                        The End
                      </div>
                      <div
                        class="multiselect-option"
                        data-entity="The Eye"
                        onclick="event.stopPropagation(); toggleCustomEnemyEntity('The Eye')"
                      >
                        <input type="checkbox" />
                        The Eye
                      </div>
                      <div
                        class="multiselect-option"
                        data-entity="The Flesh"
                        onclick="event.stopPropagation(); toggleCustomEnemyEntity('The Flesh')"
                      >
                        <input type="checkbox" />
                        The Flesh
                      </div>
                      <div
                        class="multiselect-option"
                        data-entity="The Hunt"
                        onclick="event.stopPropagation(); toggleCustomEnemyEntity('The Hunt')"
                      >
                        <input type="checkbox" />
                        The Hunt
                      </div>
                      <div
                        class="multiselect-option"
                        data-entity="The Lonely"
                        onclick="event.stopPropagation(); toggleCustomEnemyEntity('The Lonely')"
                      >
                        <input type="checkbox" />
                        The Lonely
                      </div>
                      <div
                        class="multiselect-option"
                        data-entity="The Slaughter"
                        onclick="event.stopPropagation(); toggleCustomEnemyEntity('The Slaughter')"
                      >
                        <input type="checkbox" />
                        The Slaughter
                      </div>
                      <div
                        class="multiselect-option"
                        data-entity="The Spiral"
                        onclick="event.stopPropagation(); toggleCustomEnemyEntity('The Spiral')"
                      >
                        <input type="checkbox" />
                        The Spiral
                      </div>
                      <div
                        class="multiselect-option"
                        data-entity="The Stranger"
                        onclick="event.stopPropagation(); toggleCustomEnemyEntity('The Stranger')"
                      >
                        <input type="checkbox" />
                        The Stranger
                      </div>
                      <div
                        class="multiselect-option"
                        data-entity="The Vast"
                        onclick="event.stopPropagation(); toggleCustomEnemyEntity('The Vast')"
                      >
                        <input type="checkbox" />
                        The Vast
                      </div>
                      <div
                        class="multiselect-option"
                        data-entity="The Web"
                        onclick="event.stopPropagation(); toggleCustomEnemyEntity('The Web')"
                      >
                        <input type="checkbox" />
                        The Web
                      </div>
                    </div>
                  </div>
                </div>

                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr 1fr;
                    gap: 15px;
                    margin-bottom: 15px;
                  "
                >
                  <div>
                    <label
                      for="customEnemyHealth"
                      style="display: block; margin-bottom: 5px; color: #ccc"
                      >Health *</label
                    >
                    <input
                      type="number"
                      id="customEnemyHealth"
                      min="1"
                      value="10"
                      style="
                        width: 100%;
                        padding: 8px;
                        background: rgba(0, 0, 0, 0.3);
                        border: 1px solid #4caf50;
                        border-radius: 4px;
                        color: #e0e0e0;
                      "
                    />
                  </div>

                  <div>
                    <label
                      for="customEnemyStress"
                      style="display: block; margin-bottom: 5px; color: #ccc"
                      >Stress</label
                    >
                    <input
                      type="number"
                      id="customEnemyStress"
                      min="0"
                      value="0"
                      style="
                        width: 100%;
                        padding: 8px;
                        background: rgba(0, 0, 0, 0.3);
                        border: 1px solid #4caf50;
                        border-radius: 4px;
                        color: #e0e0e0;
                      "
                    />
                  </div>

                  <div>
                    <label
                      for="customEnemyDamage"
                      style="display: block; margin-bottom: 5px; color: #ccc"
                      >Damage *</label
                    >
                    <input
                      type="text"
                      id="customEnemyDamage"
                      placeholder="e.g., 4 points"
                      value="3 points"
                      style="
                        width: 100%;
                        padding: 8px;
                        background: rgba(0, 0, 0, 0.3);
                        border: 1px solid #4caf50;
                        border-radius: 4px;
                        color: #e0e0e0;
                      "
                    />
                  </div>
                </div>

                <div style="margin-bottom: 15px">
                  <label
                    for="customEnemyMovement"
                    style="display: block; margin-bottom: 5px; color: #ccc"
                    >Movement</label
                  >
                  <input
                    type="text"
                    id="customEnemyMovement"
                    placeholder="e.g., Short"
                    style="
                      width: 100%;
                      padding: 8px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #4caf50;
                      border-radius: 4px;
                      color: #e0e0e0;
                    "
                  />
                </div>

                <div style="margin-bottom: 15px">
                  <label
                    for="customEnemyCombat"
                    style="display: block; margin-bottom: 5px; color: #ccc"
                    >Combat</label
                  >
                  <textarea
                    id="customEnemyCombat"
                    rows="2"
                    placeholder="Combat tactics and behavior..."
                    style="
                      width: 100%;
                      padding: 8px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #4caf50;
                      border-radius: 4px;
                      color: #e0e0e0;
                    "
                  ></textarea>
                </div>

                <div style="margin-bottom: 15px">
                  <label
                    for="customEnemyModifications"
                    style="display: block; margin-bottom: 5px; color: #ccc"
                    >Modifications</label
                  >
                  <textarea
                    id="customEnemyModifications"
                    rows="2"
                    placeholder="Task modifications and bonuses..."
                    style="
                      width: 100%;
                      padding: 8px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #4caf50;
                      border-radius: 4px;
                      color: #e0e0e0;
                    "
                  ></textarea>
                </div>

                <div style="margin-bottom: 15px">
                  <label style="display: block; margin-bottom: 5px; color: #ccc"
                    >Abilities</label
                  >
                  <div
                    id="customEnemyAbilitiesList"
                    style="margin-bottom: 10px"
                  ></div>
                  <button
                    class="button"
                    onclick="addCustomAbility()"
                    style="padding: 6px 12px; font-size: 0.9em"
                  >
                    + Add Ability
                  </button>
                </div>

                <div style="margin-bottom: 15px">
                  <label
                    for="customEnemyGMNotes"
                    style="display: block; margin-bottom: 5px; color: #ccc"
                    >GM Notes</label
                  >
                  <textarea
                    id="customEnemyGMNotes"
                    rows="3"
                    placeholder="Private notes, plot hooks, special tactics..."
                    style="
                      width: 100%;
                      padding: 8px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #4caf50;
                      border-radius: 4px;
                      color: #e0e0e0;
                      resize: vertical;
                    "
                  ></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px">
                  <button
                    class="button primary-button"
                    onclick="saveCustomEnemy()"
                    style="flex: 1"
                  >
                    üíæ Save Enemy
                  </button>
                  <button
                    class="button"
                    onclick="clearCustomEnemyForm()"
                    style="
                      flex: 1;
                      background: rgba(211, 47, 47, 0.2);
                      border-color: #d32f2f;
                    "
                  >
                    Clear Form
                  </button>
                </div>
              </div>

              <!-- Bestiary List -->
              <div id="customEnemiesList" style="margin-top: 20px">
                <div
                  style="
                    display: flex;
                    gap: 10px;
                    margin-bottom: 15px;
                    flex-wrap: wrap;
                  "
                >
                  <button
                    class="button primary-button"
                    onclick="toggleCustomEnemyForm()"
                    style="padding: 10px 20px; flex: 1; min-width: 200px"
                  >
                    ‚ûï Create New Enemy
                  </button>
                  <button
                    class="button"
                    onclick="document.getElementById('bestiaryUpload').click()"
                    style="
                      padding: 10px 20px;
                      background: rgba(33, 150, 243, 0.2);
                      border: 1px solid #2196f3;
                      color: #64b5f6;
                      flex: 1;
                      min-width: 200px;
                    "
                    title="Upload a JSON file with multiple enemies"
                  >
                    üì§ Upload JSON
                  </button>
                  <button
                    class="button"
                    onclick="exportBestiaryJSON()"
                    style="
                      padding: 10px 20px;
                      background: rgba(255, 152, 0, 0.2);
                      border: 1px solid #ff9800;
                      color: #ffb74d;
                      flex: 1;
                      min-width: 200px;
                    "
                    title="Download your bestiary as JSON"
                  >
                    üíæ Export JSON
                  </button>
                  <button
                    class="button"
                    onclick="downloadBestiaryTemplate()"
                    style="
                      padding: 10px 20px;
                      background: rgba(76, 175, 80, 0.2);
                      border: 1px solid #4caf50;
                      color: #81c784;
                      flex: 1;
                      min-width: 200px;
                    "
                    title="Download a blank template to create your own bestiary"
                  >
                    üìã Download Template
                  </button>
                  <input
                    type="file"
                    id="bestiaryUpload"
                    accept=".json"
                    style="display: none"
                    onchange="importBestiaryJSON(event)"
                  />
                </div>

                <div
                  class="reference-filters"
                  style="
                    display: grid;
                    grid-template-columns: 2fr 1fr 1fr 100px;
                    gap: 10px;
                    margin-bottom: 20px;
                  "
                >
                  <input
                    type="text"
                    id="customEnemySearchName"
                    placeholder="Search by name..."
                    oninput="filterCustomEnemies()"
                    style="
                      padding: 10px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #4caf50;
                      border-radius: 6px;
                      color: #e0e0e0;
                    "
                  />
                  <select
                    id="customEnemyFilterEntity"
                    onchange="filterCustomEnemies()"
                    style="
                      padding: 10px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #4caf50;
                      border-radius: 6px;
                      color: #e0e0e0;
                    "
                  >
                    <option value="">All Entities</option>
                  </select>
                  <select
                    id="customEnemyFilterLevel"
                    onchange="filterCustomEnemies()"
                    style="
                      padding: 10px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #4caf50;
                      border-radius: 6px;
                      color: #e0e0e0;
                    "
                  >
                    <option value="">All Levels</option>
                    <option value="1">Level 1</option>
                    <option value="2">Level 2</option>
                    <option value="3">Level 3</option>
                    <option value="4">Level 4</option>
                    <option value="5">Level 5</option>
                    <option value="6">Level 6</option>
                    <option value="7">Level 7</option>
                    <option value="8">Level 8</option>
                    <option value="9">Level 9</option>
                    <option value="10">Level 10</option>
                  </select>
                  <button
                    class="button"
                    onclick="clearCustomEnemyFilters()"
                    style="padding: 10px"
                  >
                    Clear
                  </button>
                </div>

                <div id="customEnemiesContainer"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Artefacts Tab -->
      <div id="artefacts" class="tab-content">
        <div class="section">
          <h2
            style="
              cursor: pointer;
              user-select: none;
              display: flex;
              align-items: center;
              gap: 10px;
            "
            onclick="toggleArtefactsSection()"
          >
            <span id="artefactsToggleIcon" style="font-size: 0.8em">‚ñ∂</span>
            Artefacts
          </h2>

          <!-- Artefacts Section -->
          <div
            id="artefactsSection"
            class="reference-content"
            style="padding: 20px; display: none"
          >
            <p
              style="
                color: #888;
                margin: 0 0 20px 0;
                line-height: 1.6;
                font-size: 0.95em;
              "
            >
              <strong>Create cursed objects and supernatural artefacts.</strong
              ><br />
              Design items touched by the Entities with unique effects, stress
              costs, and horrifying consequences. Upload JSON files to import
              multiple artefacts at once or download templates to create your
              own.
            </p>

            <!-- Artefact Creator Form -->
            <div
              id="customArtefactForm"
              style="
                display: none;
                background: rgba(0, 0, 0, 0.3);
                padding: 20px;
                border-radius: 8px;
                border: 1px solid #4caf50;
                margin-bottom: 20px;
              "
            >
              <h4
                style="color: #4caf50; margin-top: 0"
                id="customArtefactFormTitle"
              >
                Create New Artefact
              </h4>

              <div style="margin-bottom: 15px">
                <label
                  for="customArtefactName"
                  style="display: block; margin-bottom: 5px; color: #ccc"
                  >Name *</label
                >
                <input
                  type="text"
                  id="customArtefactName"
                  placeholder="Artefact name..."
                  style="
                    padding: 8px;
                    width: calc(100% - 16px);
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 4px;
                    color: #e0e0e0;
                  "
                />
              </div>

              <div style="margin-bottom: 15px">
                <label
                  for="customArtefactLevel"
                  style="display: block; margin-bottom: 5px; color: #ccc"
                  >Level</label
                >
                <input
                  type="text"
                  id="customArtefactLevel"
                  placeholder="Level (1-10 or dice like 1d6)"
                  style="
                    padding: 8px;
                    width: calc(100% - 16px);
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 4px;
                    color: #e0e0e0;
                  "
                />
              </div>

              <div style="margin-bottom: 15px">
                <label
                  for="customArtefactEntity"
                  style="display: block; margin-bottom: 5px; color: #ccc"
                  >Related Entity/Entities</label
                >
                <div class="custom-multiselect">
                  <div
                    style="
                      padding: 10px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #4caf50;
                      border-radius: 4px;
                      color: #e0e0e0;
                      cursor: pointer;
                      user-select: none;
                    "
                    onclick="toggleArtefactEntityDropdown()"
                  >
                    <span id="customArtefactEntityDisplay" style="color: #888"
                      >Select Entity/Entities...</span
                    >
                  </div>
                  <div id="customArtefactEntityDropdown" style="display: none">
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="All"
                        onchange="updateArtefactEntityDisplay()"
                      />
                      All
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="Any"
                        onchange="updateArtefactEntityDisplay()"
                      />
                      Any
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Buried"
                        onchange="updateArtefactEntityDisplay()"
                      />
                      The Buried
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Corruption"
                        onchange="updateArtefactEntityDisplay()"
                      />
                      The Corruption
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Dark"
                        onchange="updateArtefactEntityDisplay()"
                      />
                      The Dark
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Desolation"
                        onchange="updateArtefactEntityDisplay()"
                      />
                      The Desolation
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The End"
                        onchange="updateArtefactEntityDisplay()"
                      />
                      The End
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Extinction"
                        onchange="updateArtefactEntityDisplay()"
                      />
                      The Extinction
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Eye"
                        onchange="updateArtefactEntityDisplay()"
                      />
                      The Eye
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Flesh"
                        onchange="updateArtefactEntityDisplay()"
                      />
                      The Flesh
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Hunt"
                        onchange="updateArtefactEntityDisplay()"
                      />
                      The Hunt
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Lonely"
                        onchange="updateArtefactEntityDisplay()"
                      />
                      The Lonely
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Slaughter"
                        onchange="updateArtefactEntityDisplay()"
                      />
                      The Slaughter
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Spiral"
                        onchange="updateArtefactEntityDisplay()"
                      />
                      The Spiral
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Stranger"
                        onchange="updateArtefactEntityDisplay()"
                      />
                      The Stranger
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Vast"
                        onchange="updateArtefactEntityDisplay()"
                      />
                      The Vast
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Web"
                        onchange="updateArtefactEntityDisplay()"
                      />
                      The Web
                    </label>
                  </div>
                </div>
              </div>

              <div style="margin-bottom: 15px">
                <label
                  for="customArtefactDescription"
                  style="display: block; margin-bottom: 5px; color: #ccc"
                  >Description</label
                >
                <textarea
                  id="customArtefactDescription"
                  placeholder="Physical appearance, what it does, mechanical effects, defense rolls required, etc..."
                  rows="4"
                  style="
                    width: calc(100% - 16px);
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 4px;
                    color: #e0e0e0;
                    resize: vertical;
                  "
                ></textarea>
              </div>

              <div
                style="
                  display: grid;
                  grid-template-columns: 1fr 2fr;
                  gap: 15px;
                  margin-bottom: 15px;
                "
              >
                <div>
                  <label
                    for="customArtefactStressAmount"
                    style="display: block; margin-bottom: 5px; color: #ccc"
                    >Stress Amount</label
                  >
                  <input
                    type="number"
                    id="customArtefactStressAmount"
                    placeholder="e.g., 3"
                    min="1"
                    style="
                      width: calc(100% - 16px);
                      padding: 8px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #4caf50;
                      border-radius: 4px;
                      color: #e0e0e0;
                    "
                  />
                </div>

                <div>
                  <label
                    for="customArtefactStressWhen"
                    style="display: block; margin-bottom: 5px; color: #ccc"
                    >When Stress is Gained</label
                  >
                  <input
                    type="text"
                    id="customArtefactStressWhen"
                    placeholder="e.g., Upon use; when realizing its power"
                    style="
                      width: calc(100% - 16px);
                      padding: 8px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #4caf50;
                      border-radius: 4px;
                      color: #e0e0e0;
                    "
                  />
                </div>
              </div>

              <div style="margin-bottom: 15px">
                <label
                  for="customArtefactFear"
                  style="display: block; margin-bottom: 5px; color: #ccc"
                  >Fear</label
                >
                <textarea
                  id="customArtefactFear"
                  placeholder="Worst possible outcome or horrifying consequence..."
                  rows="2"
                  style="
                    width: calc(100% - 16px);
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 4px;
                    color: #e0e0e0;
                    resize: vertical;
                  "
                ></textarea>
              </div>

              <div style="margin-bottom: 15px">
                <label
                  for="customArtefactGMNotes"
                  style="display: block; margin-bottom: 5px; color: #ccc"
                  >GM Notes</label
                >
                <textarea
                  id="customArtefactGMNotes"
                  placeholder="Optional private notes for yourself..."
                  rows="3"
                  style="
                    width: calc(100% - 16px);
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 4px;
                    color: #e0e0e0;
                    resize: vertical;
                  "
                ></textarea>
              </div>

              <div style="display: flex; gap: 10px; margin-top: 20px">
                <button
                  class="button primary-button"
                  onclick="saveCustomArtefact()"
                  style="flex: 1"
                >
                  üíæ Save Artefact
                </button>
                <button
                  class="button"
                  onclick="clearCustomArtefactForm()"
                  style="
                    flex: 1;
                    background: rgba(211, 47, 47, 0.2);
                    border-color: #d32f2f;
                  "
                >
                  Clear Form
                </button>
              </div>
            </div>

            <!-- Artefacts List -->
            <div id="customArtefactsList" style="margin-top: 20px">
              <div
                style="
                  display: flex;
                  gap: 10px;
                  margin: 0 0 20px 0;
                  flex-wrap: wrap;
                "
              >
                <button
                  class="button primary-button"
                  onclick="toggleCustomArtefactForm()"
                  style="padding: 10px 20px; flex: 1; min-width: 200px"
                >
                  ‚ûï Create New Artefact
                </button>
                <button
                  class="button"
                  onclick="document.getElementById('artefactsUpload').click()"
                  style="
                    padding: 10px 20px;
                    background: rgba(33, 150, 243, 0.2);
                    border: 1px solid #2196f3;
                    color: #64b5f6;
                    flex: 1;
                    min-width: 200px;
                  "
                  title="Upload a JSON file with multiple artefacts"
                >
                  üì§ Upload JSON
                </button>
                <button
                  class="button"
                  onclick="exportArtefactsJSON()"
                  style="
                    padding: 10px 20px;
                    background: rgba(255, 152, 0, 0.2);
                    border: 1px solid #ff9800;
                    color: #ffb74d;
                    flex: 1;
                    min-width: 200px;
                  "
                  title="Download your artefacts as JSON"
                >
                  üíæ Export JSON
                </button>
                <button
                  class="button"
                  onclick="downloadArtefactsTemplate()"
                  style="
                    padding: 10px 20px;
                    background: rgba(76, 175, 80, 0.2);
                    border: 1px solid #4caf50;
                    color: #81c784;
                    flex: 1;
                    min-width: 200px;
                  "
                  title="Download a blank template to create your own artefacts"
                >
                  üìã Download Template
                </button>
                <input
                  type="file"
                  id="artefactsUpload"
                  accept=".json"
                  style="display: none"
                  onchange="importArtefactsJSON(event)"
                />
              </div>

              <div
                class="reference-filters"
                style="
                  display: grid;
                  grid-template-columns: 2fr 1fr 100px;
                  gap: 10px;
                  margin-bottom: 20px;
                "
              >
                <input
                  type="text"
                  id="customArtefactSearchName"
                  placeholder="Search by name..."
                  oninput="filterCustomArtefacts()"
                  style="
                    padding: 10px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 6px;
                    color: #e0e0e0;
                  "
                />
                <select
                  id="customArtefactFilterEntity"
                  onchange="filterCustomArtefacts()"
                  style="
                    padding: 10px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 6px;
                    color: #e0e0e0;
                  "
                >
                  <option value="">All Entities</option>
                </select>
                <button
                  class="button"
                  onclick="clearCustomArtefactsFilters()"
                  style="padding: 10px"
                >
                  Clear
                </button>
              </div>

              <div id="customArtefactsContainer"></div>
            </div>
          </div>
        </div>

        <div class="section">
          <h2
            style="
              cursor: pointer;
              user-select: none;
              display: flex;
              align-items: center;
              gap: 10px;
            "
            onclick="toggleLeitnersSection()"
          >
            <span id="leitnersToggleIcon" style="font-size: 0.8em">‚ñ∂</span>
            Leitners
          </h2>

          <!-- Leitners Section -->
          <div
            id="leitnersSection"
            class="reference-content"
            style="padding: 20px; display: none"
          >
            <p
              style="
                color: #888;
                margin-bottom: 20px;
                line-height: 1.6;
                font-size: 0.95em;
              "
            >
              <strong>Catalog forbidden tomes and cursed literature.</strong
              ><br />
              Design supernatural books from Leitner's library or other sources,
              detailing what happens when they're read, the knowledge they
              contain, and the terrible prices they exact from readers.
            </p>

            <!-- Leitner Creator Form -->
            <div
              id="customLeitnerForm"
              style="
                display: none;
                background: rgba(0, 0, 0, 0.3);
                padding: 20px;
                border-radius: 8px;
                border: 1px solid #4caf50;
                margin-bottom: 20px;
              "
            >
              <h4
                style="color: #4caf50; margin-top: 0"
                id="customLeitnerFormTitle"
              >
                Create New Leitner
              </h4>

              <div style="margin-bottom: 15px">
                <label
                  for="customLeitnerName"
                  style="display: block; margin-bottom: 5px; color: #ccc"
                  >Book Title *</label
                >
                <input
                  type="text"
                  id="customLeitnerName"
                  placeholder="Book title..."
                  style="
                    width: calc(100% - 16px);
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 4px;
                    color: #e0e0e0;
                  "
                />
              </div>

              <div style="margin-bottom: 15px">
                <label
                  for="customLeitnerLevel"
                  style="display: block; margin-bottom: 5px; color: #ccc"
                  >Level</label
                >
                <input
                  type="text"
                  id="customLeitnerLevel"
                  placeholder="Level (1-10 or dice like 1d6)"
                  style="
                    width: calc(100% - 16px);
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 4px;
                    color: #e0e0e0;
                  "
                />
              </div>

              <div style="margin-bottom: 15px">
                <label
                  for="customLeitnerEntity"
                  style="display: block; margin-bottom: 5px; color: #ccc"
                  >Related Entity/Entities</label
                >
                <div class="custom-multiselect">
                  <div
                    style="
                      padding: 10px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #4caf50;
                      border-radius: 4px;
                      color: #e0e0e0;
                      cursor: pointer;
                      user-select: none;
                    "
                    onclick="toggleLeitnerEntityDropdown()"
                  >
                    <span id="customLeitnerEntityDisplay" style="color: #888"
                      >Select Entity/Entities...</span
                    >
                  </div>
                  <div id="customLeitnerEntityDropdown" style="display: none">
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="All"
                        onchange="updateLeitnerEntityDisplay()"
                      />
                      All
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="Any"
                        onchange="updateLeitnerEntityDisplay()"
                      />
                      Any
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Buried"
                        onchange="updateLeitnerEntityDisplay()"
                      />
                      The Buried
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Corruption"
                        onchange="updateLeitnerEntityDisplay()"
                      />
                      The Corruption
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Dark"
                        onchange="updateLeitnerEntityDisplay()"
                      />
                      The Dark
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Desolation"
                        onchange="updateLeitnerEntityDisplay()"
                      />
                      The Desolation
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The End"
                        onchange="updateLeitnerEntityDisplay()"
                      />
                      The End
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Extinction"
                        onchange="updateLeitnerEntityDisplay()"
                      />
                      The Extinction
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Eye"
                        onchange="updateLeitnerEntityDisplay()"
                      />
                      The Eye
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Flesh"
                        onchange="updateLeitnerEntityDisplay()"
                      />
                      The Flesh
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Hunt"
                        onchange="updateLeitnerEntityDisplay()"
                      />
                      The Hunt
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Lonely"
                        onchange="updateLeitnerEntityDisplay()"
                      />
                      The Lonely
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Slaughter"
                        onchange="updateLeitnerEntityDisplay()"
                      />
                      The Slaughter
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Spiral"
                        onchange="updateLeitnerEntityDisplay()"
                      />
                      The Spiral
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Stranger"
                        onchange="updateLeitnerEntityDisplay()"
                      />
                      The Stranger
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Vast"
                        onchange="updateLeitnerEntityDisplay()"
                      />
                      The Vast
                    </label>
                    <label
                      style="display: block; padding: 5px; cursor: pointer"
                    >
                      <input
                        type="checkbox"
                        value="The Web"
                        onchange="updateLeitnerEntityDisplay()"
                      />
                      The Web
                    </label>
                  </div>
                </div>
              </div>

              <div style="margin-bottom: 15px">
                <label
                  for="customLeitnerDescription"
                  style="display: block; margin-bottom: 5px; color: #ccc"
                  >Description</label
                >
                <textarea
                  id="customLeitnerDescription"
                  placeholder="Physical appearance, what happens when read, mechanical effects, defense rolls required, etc..."
                  rows="4"
                  style="
                    width: calc(100% - 16px);
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 4px;
                    color: #e0e0e0;
                    resize: vertical;
                  "
                ></textarea>
              </div>

              <div
                style="
                  display: grid;
                  grid-template-columns: 1fr 2fr;
                  gap: 15px;
                  margin-bottom: 15px;
                "
              >
                <div>
                  <label
                    for="customLeitnerStressAmount"
                    style="display: block; margin-bottom: 5px; color: #ccc"
                    >Stress Amount</label
                  >
                  <input
                    type="number"
                    id="customLeitnerStressAmount"
                    placeholder="e.g., 3"
                    min="1"
                    style="
                      width: calc(100% - 16px);
                      padding: 8px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #4caf50;
                      border-radius: 4px;
                      color: #e0e0e0;
                    "
                  />
                </div>

                <div>
                  <label
                    for="customLeitnerStressWhen"
                    style="display: block; margin-bottom: 5px; color: #ccc"
                    >When Stress is Gained</label
                  >
                  <input
                    type="text"
                    id="customLeitnerStressWhen"
                    placeholder="e.g., When read; upon completion"
                    style="
                      width: calc(100% - 16px);
                      padding: 8px;
                      background: rgba(0, 0, 0, 0.3);
                      border: 1px solid #4caf50;
                      border-radius: 4px;
                      color: #e0e0e0;
                    "
                  />
                </div>
              </div>

              <div style="margin-bottom: 15px">
                <label
                  for="customLeitnerFear"
                  style="display: block; margin-bottom: 5px; color: #ccc"
                  >Fear</label
                >
                <textarea
                  id="customLeitnerFear"
                  placeholder="Worst possible outcome or horrifying consequence..."
                  rows="2"
                  style="
                    width: calc(100% - 16px);
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 4px;
                    color: #e0e0e0;
                    resize: vertical;
                  "
                ></textarea>
              </div>

              <div style="margin-bottom: 15px">
                <label
                  for="customLeitnerGMNotes"
                  style="display: block; margin-bottom: 5px; color: #ccc"
                  >GM Notes</label
                >
                <textarea
                  id="customLeitnerGMNotes"
                  placeholder="Optional private notes for yourself..."
                  rows="3"
                  style="
                    width: calc(100% - 16px);
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 4px;
                    color: #e0e0e0;
                    resize: vertical;
                  "
                ></textarea>
              </div>

              <div style="display: flex; gap: 10px; margin-top: 20px">
                <button
                  class="button primary-button"
                  onclick="saveCustomLeitner()"
                  style="flex: 1"
                >
                  üíæ Save Leitner
                </button>
                <button
                  class="button"
                  onclick="clearCustomLeitnerForm()"
                  style="
                    flex: 1;
                    background: rgba(211, 47, 47, 0.2);
                    border-color: #d32f2f;
                  "
                >
                  Clear Form
                </button>
              </div>
            </div>

            <!-- Leitners List -->
            <div id="customLeitnersList" style="margin-top: 20px">
              <div
                style="
                  display: flex;
                  gap: 10px;
                  margin-bottom: 15px;
                  flex-wrap: wrap;
                "
              >
                <button
                  class="button primary-button"
                  onclick="toggleCustomLeitnerForm()"
                  style="padding: 10px 20px; flex: 1; min-width: 200px"
                >
                  ‚ûï Create New Leitner
                </button>
                <button
                  class="button"
                  onclick="document.getElementById('leitnersUpload').click()"
                  style="
                    padding: 10px 20px;
                    background: rgba(33, 150, 243, 0.2);
                    border: 1px solid #2196f3;
                    color: #64b5f6;
                    flex: 1;
                    min-width: 200px;
                  "
                  title="Upload a JSON file with multiple Leitner books"
                >
                  üì§ Upload JSON
                </button>
                <button
                  class="button"
                  onclick="exportLeitnersJSON()"
                  style="
                    padding: 10px 20px;
                    background: rgba(255, 152, 0, 0.2);
                    border: 1px solid #ff9800;
                    color: #ffb74d;
                    flex: 1;
                    min-width: 200px;
                  "
                  title="Download your Leitner books as JSON"
                >
                  üíæ Export JSON
                </button>
                <button
                  class="button"
                  onclick="downloadLeitnersTemplate()"
                  style="
                    padding: 10px 20px;
                    background: rgba(76, 175, 80, 0.2);
                    border: 1px solid #4caf50;
                    color: #81c784;
                    flex: 1;
                    min-width: 200px;
                  "
                  title="Download a blank template to create your own Leitner books"
                >
                  üìã Download Template
                </button>
                <input
                  type="file"
                  id="leitnersUpload"
                  accept=".json"
                  style="display: none"
                  onchange="importLeitnersJSON(event)"
                />
              </div>

              <div
                class="reference-filters"
                style="
                  display: grid;
                  grid-template-columns: 2fr 1fr 100px;
                  gap: 10px;
                  margin-bottom: 20px;
                "
              >
                <input
                  type="text"
                  id="customLeitnerSearchName"
                  placeholder="Search by name..."
                  oninput="filterCustomLeitners()"
                  style="
                    padding: 10px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 6px;
                    color: #e0e0e0;
                  "
                />
                <select
                  id="customLeitnerFilterEntity"
                  onchange="filterCustomLeitners()"
                  style="
                    padding: 10px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 6px;
                    color: #e0e0e0;
                  "
                >
                  <option value="">All Entities</option>
                </select>
                <button
                  class="button"
                  onclick="clearCustomLeitnersFilters()"
                  style="padding: 10px"
                >
                  Clear
                </button>
              </div>

              <div id="customLeitnersContainer"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tools & Generators Tab -->
      <div id="tools" class="tab-content" style="display: none">
        <div class="section">
          <h2>Random Generators</h2>

          <div
            class="generator-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
              gap: 20px;
              margin-top: 20px;
            "
          >
            <div
              class="generator-card"
              style="
                background: rgba(0, 0, 0, 0.3);
                padding: 20px;
                border-radius: 8px;
                border: 1px solid #4caf50;
              "
            >
              <h3 style="color: #4caf50">Random NPC</h3>
              <button class="button" onclick="generateRandomNPC()">
                Generate
              </button>
              <div
                id="randomNPCOutput"
                style="margin-top: 15px; min-height: 50px"
              ></div>
            </div>

            <div
              class="generator-card"
              style="
                background: rgba(0, 0, 0, 0.3);
                padding: 20px;
                border-radius: 8px;
                border: 1px solid #4caf50;
              "
            >
              <h3 style="color: #4caf50">Random Encounter</h3>
              <label
                >Party Tier:
                <input
                  type="number"
                  id="encounterTier"
                  value="1"
                  min="1"
                  max="6"
                  style="width: 60px"
              /></label>
              <button class="button" onclick="generateRandomEncounter()">
                Generate
              </button>
              <div
                id="randomEncounterOutput"
                style="margin-top: 15px; min-height: 50px"
              ></div>
            </div>

            <div
              class="generator-card"
              style="
                background: rgba(0, 0, 0, 0.3);
                padding: 20px;
                border-radius: 8px;
                border: 1px solid #4caf50;
              "
            >
              <h3 style="color: #4caf50">Random Cypher</h3>
              <label
                >Level:
                <input
                  type="number"
                  id="cypherLevel"
                  value="1"
                  min="1"
                  max="10"
                  style="width: 60px"
              /></label>
              <button class="button" onclick="generateRandomCypher()">
                Generate
              </button>
              <div
                id="randomCypherOutput"
                style="margin-top: 15px; min-height: 50px"
              ></div>
            </div>

            <div
              class="generator-card"
              style="
                background: rgba(0, 0, 0, 0.3);
                padding: 20px;
                border-radius: 8px;
                border: 1px solid #4caf50;
              "
            >
              <h3 style="color: #4caf50">Investigation Hook</h3>
              <button class="button" onclick="generateInvestigationHook()">
                Generate
              </button>
              <div
                id="investigationHookOutput"
                style="margin-top: 15px; min-height: 50px"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Story Notes Tab -->
      <div id="story-notes" class="tab-content">
        <div class="section">
          <h2>Session Planning & Notes</h2>
          <div class="reference-content" style="padding: 20px">
            <p
              style="
                color: #888;
                margin: 0 0 20px 0;
                line-height: 1.6;
                font-size: 0.95em;
              "
            >
              <strong>Plan your sessions and track ongoing mysteries.</strong
              ><br />
              Use this space to outline session content, track plot threads,
              note NPC interactions, and manage the web of horror unfolding in
              your campaign.
            </p>
            <div class="notes-container">
              <label for="sessionNotes">Session Notes</label>
              <textarea
                id="sessionNotes"
                rows="10"
                placeholder="Plan your session, track important events, NPC interactions, plot threads..."
                style="
                  padding: 12px;
                  width: calc(100% - 24px);
                  background: rgba(0, 0, 0, 0.3);
                  border: 1px solid #4caf50;
                  border-radius: 6px;
                  color: #e0e0e0;
                "
              ></textarea>
            </div>
          </div>
        </div>

        <div class="section">
          <h2>Plot Threads & Mysteries</h2>

          <!-- Search and Filter Bar -->
          <div
            style="
              background: rgba(0, 0, 0, 0.2);
              padding: 15px;
              border-radius: 8px;
              margin-bottom: 15px;
              display: flex;
              flex-wrap: wrap;
              gap: 10px;
              align-items: flex-end;
            "
          >
            <div style="flex: 1; min-width: 200px">
              <label
                style="
                  display: block;
                  color: #888;
                  font-size: 0.85em;
                  margin-bottom: 4px;
                "
                >Search by Name</label
              >
              <input
                type="text"
                id="plotThreadSearchName"
                placeholder="Search plot threads..."
                oninput="filterPlotThreads()"
                style="
                  padding: 8px;
                  width: calc(100% - 16px);
                  background: rgba(0, 0, 0, 0.3);
                  border: 1px solid #4caf50;
                  border-radius: 4px;
                  color: #e0e0e0;
                "
              />
            </div>
            <div style="flex: 1; min-width: 150px">
              <label
                style="
                  display: block;
                  color: #888;
                  font-size: 0.85em;
                  margin-bottom: 4px;
                "
                >Filter by Entity</label
              >
              <select
                id="plotThreadFilterEntity"
                onchange="filterPlotThreads()"
                style="
                  width: 100%;
                  padding: 8px;
                  background: rgba(0, 0, 0, 0.3);
                  border: 1px solid #4caf50;
                  border-radius: 4px;
                  color: #4caf50;
                "
              >
                <option value="">All Entities</option>
                <option value="The Buried">The Buried</option>
                <option value="The Corruption">The Corruption</option>
                <option value="The Dark">The Dark</option>
                <option value="The Desolation">The Desolation</option>
                <option value="The End">The End</option>
                <option value="The Eye">The Eye</option>
                <option value="The Flesh">The Flesh</option>
                <option value="The Hunt">The Hunt</option>
                <option value="The Lonely">The Lonely</option>
                <option value="The Slaughter">The Slaughter</option>
                <option value="The Spiral">The Spiral</option>
                <option value="The Stranger">The Stranger</option>
                <option value="The Vast">The Vast</option>
                <option value="The Web">The Web</option>
              </select>
            </div>
            <div style="display: flex; gap: 8px">
              <button
                onclick="sortPlotThreads('name')"
                style="
                  padding: 8px 15px;
                  background: rgba(76, 175, 80, 0.2);
                  border: 1px solid #4caf50;
                  color: #66bb6a;
                  border-radius: 4px;
                  cursor: pointer;
                  white-space: nowrap;
                "
              >
                Sort A-Z
              </button>
              <button
                onclick="sortPlotThreads('status')"
                style="
                  padding: 8px 15px;
                  background: rgba(76, 175, 80, 0.2);
                  border: 1px solid #4caf50;
                  color: #66bb6a;
                  border-radius: 4px;
                  cursor: pointer;
                  white-space: nowrap;
                "
              >
                Sort by Status
              </button>
              <button
                onclick="clearPlotThreadsFilters()"
                style="
                  padding: 8px 15px;
                  background: rgba(158, 158, 158, 0.2);
                  border: 1px solid #9e9e9e;
                  color: #bbb;
                  border-radius: 4px;
                  cursor: pointer;
                "
              >
                Clear
              </button>
            </div>
          </div>

          <div
            id="plotThreadsList"
            style="
              min-height: 100px;
              padding: 15px;
              background: rgba(0, 0, 0, 0.2);
              border-radius: 8px;
            "
          >
            <p class="empty-state" style="text-align: center; color: #888">
              No active plot threads. Add them as your story unfolds.
            </p>
          </div>
          <button
            class="button primary-button"
            onclick="addPlotThread()"
            style="margin: 15px"
          >
            + Add Plot Thread
          </button>
        </div>
      </div>

      <!-- Session Notes Tab -->
      <div id="session-notes" class="tab-content">
        <div class="section">
          <h2>Session Notes</h2>
          <div class="reference-content" style="padding: 20px">
            <p
              style="
                color: #888;
                margin: 0 0 20px 0;
                line-height: 1.6;
                font-size: 0.95em;
              "
            >
              <strong>Record what happens during each session.</strong><br />
              Document investigation progress, key events, decisions made, clues
              discovered, and statements given. Review past sessions to maintain
              continuity in your campaign.
            </p>
            <div class="notes-container">
              <div style="margin-bottom: 20px">
                <label for="currentSessionNumber">Session #</label>
                <input
                  type="number"
                  id="currentSessionNumber"
                  value="1"
                  min="1"
                  style="width: 100px; margin-left: 10px"
                />
                <label for="currentSessionDate" style="margin-left: 20px"
                  >Date</label
                >
                <input
                  type="date"
                  id="currentSessionDate"
                  style="margin-left: 10px"
                />
              </div>

              <div
                style="margin-bottom: 15px; display: flex; align-items: center"
              >
                <label
                  for="investigationName"
                  style="width: 150px; display: inline-block"
                  >Investigation Name</label
                >
                <input
                  type="text"
                  id="investigationName"
                  placeholder="e.g., The Anglerfish"
                  style="
                    flex: 1;
                    padding: 6px 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 4px;
                    color: #e0e0e0;
                  "
                />
              </div>
              <div
                style="margin-bottom: 15px; display: flex; align-items: center"
              >
                <label
                  for="statementGiver"
                  style="width: 150px; display: inline-block"
                  >Statement Giver</label
                >
                <input
                  type="text"
                  id="statementGiver"
                  placeholder="e.g., Jonathan Sims"
                  style="
                    flex: 1;
                    padding: 6px 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 4px;
                    color: #e0e0e0;
                  "
                />
              </div>

              <label for="currentSessionNotes">Notes for Current Session</label>
              <textarea
                id="currentSessionNotes"
                rows="15"
                placeholder="Record what happened this session: key events, decisions made, clues discovered, NPCs encountered..."
                style="
                  padding: 12px;
                  width: calc(100% - 24px);
                  background: rgba(0, 0, 0, 0.3);
                  border: 1px solid #4caf50;
                  border-radius: 6px;
                  color: #e0e0e0;
                "
              ></textarea>

              <div style="margin-top: 15px">
                <button
                  class="button primary-button"
                  onclick="saveSessionNotes()"
                >
                  Save Session Notes
                </button>
                <button
                  class="button"
                  onclick="viewPastSessions()"
                  style="margin-left: 10px"
                >
                  View Past Sessions
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <h2>Session History</h2>

          <!-- Sort and Filter Controls -->
          <div
            style="
              display: flex;
              gap: 10px;
              margin-bottom: 15px;
              flex-wrap: wrap;
              align-items: center;
            "
          >
            <div style="display: flex; gap: 5px; align-items: center">
              <label style="color: #888; font-size: 0.9em">Sort by:</label>
              <select
                onchange="sortSessionsBy(this.value)"
                style="
                  padding: 5px;
                  border-radius: 4px;
                  background: rgba(0, 0, 0, 0.3);
                  border: 1px solid #4caf50;
                  color: #e0e0e0;
                "
              >
                <option value="number-desc">Session # (High to Low)</option>
                <option value="number-asc">Session # (Low to High)</option>
                <option value="date-desc">Date (Newest First)</option>
                <option value="date-asc">Date (Oldest First)</option>
                <option value="title-asc">Title (A-Z)</option>
                <option value="title-desc">Title (Z-A)</option>
                <option value="giver-asc">Statement Giver (A-Z)</option>
                <option value="giver-desc">Statement Giver (Z-A)</option>
              </select>
            </div>

            <div
              style="
                display: flex;
                gap: 5px;
                align-items: center;
                flex: 1;
                min-width: 200px;
              "
            >
              <label style="color: #888; font-size: 0.9em">Filter:</label>
              <input
                type="text"
                id="sessionFilterInput"
                placeholder="Search title, giver, or session #..."
                oninput="filterSessions(this.value)"
                style="
                  flex: 1;
                  padding: 5px 10px;
                  border-radius: 4px;
                  background: rgba(0, 0, 0, 0.3);
                  border: 1px solid #4caf50;
                  color: #e0e0e0;
                "
              />
              <button
                onclick="clearSessionFilters()"
                class="button"
                style="padding: 5px 10px; background: #666"
              >
                Clear
              </button>
            </div>
          </div>

          <div
            id="sessionHistoryList"
            style="
              min-height: 150px;
              padding: 15px;
              background: rgba(0, 0, 0, 0.2);
              border-radius: 8px;
              max-height: 400px;
              overflow-y: auto;
            "
          >
            <p class="empty-state" style="text-align: center; color: #888">
              No previous sessions recorded yet.
            </p>
          </div>
        </div>
      </div>

      <!-- Locations Tab -->
      <div id="locations" class="tab-content">
        <div class="section">
          <h2>Locations Database</h2>
          <div class="reference-content" style="padding: 20px">
            <p
              style="
                color: #888;
                margin: 0 0 20px 0;
                line-height: 1.6;
                font-size: 0.95em;
              "
            >
              <strong>Map the settings of your investigations.</strong><br />
              Create and organize locations your investigators will explore.
              Track which NPCs, enemies, artefacts, and Leitner books are found
              at each site, building a comprehensive reference for your campaign
              world.
            </p>

            <!-- Location Creation Form -->
            <div
              id="customLocationForm"
              style="
                display: none;
                margin-bottom: 20px;
                background: rgba(76, 175, 80, 0.1);
                border: 1px solid #4caf50;
                border-radius: 6px;
                padding: 15px;
              "
            >
              <h3
                style="
                  font-weight: bold;
                  color: #4caf50;
                  margin-top: 0;
                  margin-bottom: 15px;
                "
                id="customLocationFormTitle"
              >
                ‚ûï Create New Location
              </h3>
              <div style="display: grid; gap: 15px">
                <input
                  type="text"
                  id="customLocationName"
                  placeholder="Location name..."
                  style="
                    padding: 10px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 4px;
                    color: #e0e0e0;
                  "
                />

                <input
                  type="text"
                  id="customLocationAddress"
                  placeholder="Address / Coordinates / General area..."
                  style="
                    padding: 10px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 4px;
                    color: #e0e0e0;
                  "
                />

                <textarea
                  id="customLocationDescription"
                  placeholder="Description (physical appearance, atmosphere, key features, history, etc.)..."
                  rows="4"
                  style="
                    padding: 10px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 4px;
                    color: #e0e0e0;
                    resize: vertical;
                  "
                ></textarea>

                <div>
                  <label
                    style="
                      display: block;
                      margin-bottom: 5px;
                      color: #4caf50;
                      font-weight: bold;
                    "
                    >NPCs at this Location:</label
                  >
                  <div style="display: flex; gap: 10px; margin-bottom: 10px">
                    <select
                      id="locationNPCsSelect"
                      multiple
                      size="4"
                      style="
                        flex: 1;
                        background: rgba(0, 0, 0, 0.3);
                        color: #fff;
                        border: 1px solid #4caf50;
                        border-radius: 4px;
                        padding: 8px;
                      "
                    >
                      <option value="">-- Select NPCs --</option>
                    </select>
                    <button
                      class="button"
                      onclick="addSelectedNPCsToLocation()"
                      style="
                        background: rgba(76, 175, 80, 0.2);
                        border-color: #4caf50;
                        padding: 8px 15px;
                        white-space: nowrap;
                      "
                    >
                      + Add Selected
                    </button>
                  </div>
                  <div
                    id="locationNPCsList"
                    style="
                      min-height: 40px;
                      padding: 10px;
                      background: rgba(0, 0, 0, 0.2);
                      border: 1px solid #4caf50;
                      border-radius: 4px;
                    "
                  >
                    <p style="color: #888; font-size: 0.9em">
                      No NPCs added yet
                    </p>
                  </div>
                </div>

                <div>
                  <label
                    style="
                      display: block;
                      margin-bottom: 5px;
                      color: #4caf50;
                      font-weight: bold;
                    "
                    >Enemies at this Location:</label
                  >
                  <div style="display: flex; gap: 10px; margin-bottom: 10px">
                    <select
                      id="locationEnemiesSelect"
                      multiple
                      size="4"
                      style="
                        flex: 1;
                        background: rgba(0, 0, 0, 0.3);
                        color: #fff;
                        border: 1px solid #f44336;
                        border-radius: 4px;
                        padding: 8px;
                      "
                    >
                      <option value="">-- Select Enemies --</option>
                    </select>
                    <button
                      class="button"
                      onclick="addSelectedEnemiesToLocation()"
                      style="
                        background: rgba(244, 67, 54, 0.2);
                        border-color: #f44336;
                        padding: 8px 15px;
                        white-space: nowrap;
                      "
                    >
                      + Add Selected
                    </button>
                  </div>
                  <div
                    id="locationEnemiesList"
                    style="
                      min-height: 40px;
                      padding: 10px;
                      background: rgba(0, 0, 0, 0.2);
                      border: 1px solid #f44336;
                      border-radius: 4px;
                    "
                  >
                    <p style="color: #888; font-size: 0.9em">
                      No enemies added yet
                    </p>
                  </div>
                </div>

                <div>
                  <label
                    style="
                      display: block;
                      margin-bottom: 5px;
                      color: #4caf50;
                      font-weight: bold;
                    "
                    >Artefacts at this Location:</label
                  >
                  <div style="display: flex; gap: 10px; margin-bottom: 10px">
                    <select
                      id="locationArtefactsSelect"
                      multiple
                      size="4"
                      style="
                        flex: 1;
                        background: rgba(0, 0, 0, 0.3);
                        color: #fff;
                        border: 1px solid #ff9800;
                        border-radius: 4px;
                        padding: 8px;
                      "
                    >
                      <option value="">-- Select Artefacts --</option>
                    </select>
                    <button
                      class="button"
                      onclick="addSelectedArtefactsToLocation()"
                      style="
                        background: rgba(255, 152, 0, 0.2);
                        border-color: #ff9800;
                        padding: 8px 15px;
                        white-space: nowrap;
                      "
                    >
                      + Add Selected
                    </button>
                  </div>
                  <div
                    id="locationArtefactsList"
                    style="
                      min-height: 40px;
                      padding: 10px;
                      background: rgba(0, 0, 0, 0.2);
                      border: 1px solid #ff9800;
                      border-radius: 4px;
                    "
                  >
                    <p style="color: #888; font-size: 0.9em">
                      No artefacts added yet
                    </p>
                  </div>
                </div>

                <div>
                  <label
                    style="
                      display: block;
                      margin-bottom: 5px;
                      color: #4caf50;
                      font-weight: bold;
                    "
                    >Leitner Books at this Location:</label
                  >
                  <div style="display: flex; gap: 10px; margin-bottom: 10px">
                    <select
                      id="locationLeitnersSelect"
                      multiple
                      size="4"
                      style="
                        flex: 1;
                        background: rgba(0, 0, 0, 0.3);
                        color: #fff;
                        border: 1px solid #9c27b0;
                        border-radius: 4px;
                        padding: 8px;
                      "
                    >
                      <option value="">-- Select Leitner Books --</option>
                    </select>
                    <button
                      class="button"
                      onclick="addSelectedLeitnersToLocation()"
                      style="
                        background: rgba(156, 39, 176, 0.2);
                        border-color: #9c27b0;
                        padding: 8px 15px;
                        white-space: nowrap;
                      "
                    >
                      + Add Selected
                    </button>
                  </div>
                  <div
                    id="locationLeitnersList"
                    style="
                      min-height: 40px;
                      padding: 10px;
                      background: rgba(0, 0, 0, 0.2);
                      border: 1px solid #9c27b0;
                      border-radius: 4px;
                    "
                  >
                    <p style="color: #888; font-size: 0.9em">
                      No Leitner books added yet
                    </p>
                  </div>
                </div>

                <textarea
                  id="customLocationEquipment"
                  placeholder="Equipment & Items (list miscellaneous items, weapons, and where they can be found)..."
                  rows="3"
                  style="
                    padding: 10px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 4px;
                    color: #e0e0e0;
                    resize: vertical;
                  "
                ></textarea>

                <textarea
                  id="customLocationSupernatural"
                  placeholder="Supernatural Effects (Entity influence, paranormal phenomena, reality distortions, etc.)..."
                  rows="3"
                  style="
                    padding: 10px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 4px;
                    color: #e0e0e0;
                    resize: vertical;
                  "
                ></textarea>

                <textarea
                  id="customLocationGMNotes"
                  placeholder="GM Notes (optional, private notes for yourself)..."
                  rows="2"
                  style="
                    padding: 10px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 4px;
                    color: #e0e0e0;
                    resize: vertical;
                  "
                ></textarea>

                <div style="display: flex; gap: 10px">
                  <button
                    class="button primary-button"
                    onclick="saveCustomLocation()"
                    style="flex: 1"
                  >
                    üíæ Save Location
                  </button>
                  <button
                    class="button"
                    onclick="clearCustomLocationForm()"
                    style="
                      flex: 1;
                      background: rgba(158, 158, 158, 0.2);
                      border-color: #9e9e9e;
                    "
                  >
                    Clear Form
                  </button>
                </div>
              </div>
            </div>

            <!-- Locations List -->
            <div id="customLocationsList" style="margin-top: 20px">
              <div
                style="
                  display: flex;
                  gap: 10px;
                  margin-bottom: 15px;
                  flex-wrap: wrap;
                "
              >
                <button
                  class="button primary-button"
                  onclick="toggleCustomLocationForm()"
                  style="padding: 10px 20px; flex: 1; min-width: 200px"
                >
                  ‚ûï Create New Location
                </button>
                <button
                  class="button"
                  onclick="document.getElementById('locationsUpload').click()"
                  style="
                    padding: 10px 20px;
                    background: rgba(33, 150, 243, 0.2);
                    border: 1px solid #2196f3;
                    color: #64b5f6;
                    flex: 1;
                    min-width: 200px;
                  "
                  title="Upload a JSON file with multiple locations"
                >
                  üì§ Upload JSON
                </button>
                <button
                  class="button"
                  onclick="exportLocationsJSON()"
                  style="
                    padding: 10px 20px;
                    background: rgba(255, 152, 0, 0.2);
                    border: 1px solid #ff9800;
                    color: #ffb74d;
                    flex: 1;
                    min-width: 200px;
                  "
                  title="Download your locations as JSON"
                >
                  üíæ Export JSON
                </button>
                <button
                  class="button"
                  onclick="downloadLocationsTemplate()"
                  style="
                    padding: 10px 20px;
                    background: rgba(76, 175, 80, 0.2);
                    border: 1px solid #4caf50;
                    color: #81c784;
                    flex: 1;
                    min-width: 200px;
                  "
                  title="Download a blank template to create your own locations"
                >
                  üìã Download Template
                </button>
                <input
                  type="file"
                  id="locationsUpload"
                  accept=".json"
                  style="display: none"
                  onchange="importLocationsJSON(event)"
                />
              </div>

              <div
                class="reference-filters"
                style="
                  display: grid;
                  grid-template-columns: 2fr 1fr 100px;
                  gap: 10px;
                  margin-bottom: 20px;
                "
              >
                <input
                  type="text"
                  id="customLocationSearchName"
                  placeholder="Search by name or address..."
                  oninput="filterCustomLocations()"
                  style="
                    padding: 10px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 6px;
                    color: #e0e0e0;
                  "
                />
                <select
                  id="customLocationFilterType"
                  onchange="filterCustomLocations()"
                  style="
                    padding: 10px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #4caf50;
                    border-radius: 6px;
                    color: #e0e0e0;
                  "
                >
                  <option value="">All Locations</option>
                  <option value="hasNPCs">Has NPCs</option>
                  <option value="hasEnemies">Has Enemies</option>
                  <option value="hasArtefacts">Has Artefacts</option>
                  <option value="hasLeitners">Has Leitners</option>
                  <option value="hasSupernatural">Has Supernatural</option>
                </select>
                <button
                  class="button"
                  onclick="clearCustomLocationsFilters()"
                  style="padding: 10px"
                >
                  Clear
                </button>
              </div>

              <div id="customLocationsContainer"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Save & Load Section -->
      <details class="save-load-section">
        <summary class="save-load-header">
          <span class="save-load-icon">üíæ</span>
          <span>Save & Load Campaign</span>
        </summary>

        <div class="save-load-content">
          <div class="save-load-info">
            <p>
              <strong>Save your campaign world</strong> to your computer or
              <strong>load a previously saved campaign</strong> to continue your
              investigations. Data is automatically saved to browser storage
              every 10 minutes.
            </p>
          </div>

          <div class="save-load-buttons">
            <button
              class="save-load-btn primary"
              onclick="saveAllCampaignData()"
              title="Export all campaign data to a JSON file"
            >
              <span class="btn-icon">üíæ</span>
              <span class="btn-text">Save Campaign</span>
            </button>
            <button
              class="save-load-btn secondary"
              onclick="promptLoadCampaignFile()"
              title="Import campaign data from a JSON file"
            >
              <span class="btn-icon">üìÇ</span>
              <span class="btn-text">Load Campaign</span>
            </button>
            <button
              class="save-load-btn secondary"
              onclick="saveAutosave()"
              title="Manually save to autosave slot (also saves automatically every 10 minutes)"
            >
              <span class="btn-icon">üíæ</span>
              <span class="btn-text">Quick Save</span>
            </button>
            <button
              class="save-load-btn secondary"
              onclick="loadAutosave()"
              title="Load from autosave slot"
            >
              <span class="btn-icon">üì•</span>
              <span class="btn-text">Load Autosave</span>
            </button>
            <button
              class="save-load-btn secondary"
              onclick="resetCampaign()"
              title="Delete all campaign data and start fresh"
              style="border-color: #d32f2f"
            >
              <span class="btn-icon">üóëÔ∏è</span>
              <span class="btn-text">Reset All</span>
            </button>
          </div>

          <input
            type="file"
            id="campaignFileInput"
            accept=".json"
            style="display: none"
            onchange="loadAllCampaignData(event)"
          />

          <div id="output" style="display: none"></div>
        </div>
      </details>
    </div>

    <!-- Optional: Output display for debugging
        <details style="margin-top: 20px">
          <summary
            style="
              cursor: pointer;
              padding: 10px;
              background: #2a2a2a;
              border-radius: 6px;
            "
          >
            Show Character Data (Debug)
          </summary>
          <pre id="output" style="margin-top: 10px"></pre>
        </details> -->

    <!-- ==================== JAVASCRIPT FILES ==================== -->

    <!-- ==================== DATA FILES FIRST (No dependencies) ==================== -->
    <script src="tables/difficulties.js"></script>

    <!-- ==================== FEATURE MODULES ==================== -->

    <!-- ==================== GM TOOL FUNCTION FILES ==================== -->
    <script src="functions/dashboard.js?v=2"></script>
    <script src="functions/party.js?v=2"></script>
    <script src="functions/combat.js?v=2"></script>
    <script src="functions/npcs.js?v=5"></script>
    <script src="functions/reference.js?v=3"></script>
    <script src="functions/bestiary.js?v=1"></script>
    <script src="functions/artefacts.js?v=1"></script>
    <script src="functions/leitners.js?v=1"></script>
    <script src="functions/locations.js"></script>
    <script src="functions/tools.js?v=2"></script>
    <script src="functions/toolbar.js?v=2"></script>
    <script src="functions/save-load.js"></script>

    <!-- ==================== LEGACY CHARACTER SHEET FILES (May be removed later) ==================== -->
    <!-- <script src="functions/equipment.js"></script>
    <script src="functions/advancement.js"></script>
    <script src="functions/skills.js"></script>
    <script src="functions/abilities-management.js"></script>
    <script src="functions/recovery.js"></script>
    <script src="functions/calculators.js"></script>
    <script src="functions/connections.js"></script>
    <script src="functions/arcs.js"></script>
    <script src="functions/avatar.js"></script>
    <script src="functions/cypher-system.js"></script>
    <script src="functions/stress+damage.js"></script>
    <script src="functions/save-load.js"></script>
    <script src="functions/ui-helpers.js"></script>
    <script src="functions/character.js"></script> -->

    <!-- ==================== GLOBAL SCOPE ASSIGNMENTS ==================== -->
    <script src="functions/global.js"></script>

    <!-- ==================== TAB SYSTEM ==================== -->
    <script src="functions/tab-system.js"></script>

    <!-- ==================== INITIALIZATION (MUST BE LAST) ==================== -->
    <script src="functions/main.js"></script>

    <!-- Collapsible Section Toggle Functions -->
    <script>
      function toggleArtefactsSection() {
        const section = document.getElementById("artefactsSection");
        const icon = document.getElementById("artefactsToggleIcon");
        if (section.style.display === "none") {
          section.style.display = "block";
          icon.textContent = "‚ñº";
        } else {
          section.style.display = "none";
          icon.textContent = "‚ñ∂";
        }
      }

      function toggleLeitnersSection() {
        const section = document.getElementById("leitnersSection");
        const icon = document.getElementById("leitnersToggleIcon");
        if (section.style.display === "none") {
          section.style.display = "block";
          icon.textContent = "‚ñº";
        } else {
          section.style.display = "none";
          icon.textContent = "‚ñ∂";
        }
      }
    </script>
  </body>
</html>
